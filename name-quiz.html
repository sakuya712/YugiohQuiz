<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚«ãƒ¼ãƒ‰åå½“ã¦ã‚¯ã‚¤ã‚º</title>
    <link rel="stylesheet" href="style.css"> 
    <style>
        /* ç°¡å˜ãªCSSã‚’è¿½åŠ ã—ã¦é¸æŠè‚¢ã‚’è¦‹ã‚„ã™ãã—ã¦ã„ã¾ã™ */
        #options-area {
            display: grid;
            grid-template-columns: 1fr 1fr; /* 2åˆ—è¡¨ç¤º */
            gap: 10px;
            margin-top: 20px;
        }
        .option-button {
            padding: 10px;
            font-size: 16px;
            cursor: pointer;
            border: 1px solid #ccc;
            background-color: #f9f9f9;
            border-radius: 5px;
            transition: background-color 0.2s;
        }
        .option-button:hover:not(:disabled) {
            background-color: #e0e0e0;
        }
        .correct { background-color: #d4edda; color: #155724; border-color: #c3e6cb; }
        .incorrect { background-color: #f8d7da; color: #721c24; border-color: #f5c6cb; }
    </style>
</head>
<body>

    <div id="quiz-container">
        <h2>ã“ã®ã‚«ãƒ¼ãƒ‰ã®åå‰ã¯ï¼Ÿ</h2>
        
        <img id="card-image" src="" alt="ã‚«ãƒ¼ãƒ‰ã®ã‚¤ãƒ©ã‚¹ãƒˆ" style="max-width: 100%; height: auto;">
        
        <div id="options-area">
            </div>
        
        <p id="feedback"></p>
        
        <button id="next-button" style="display: none;">æ¬¡ã®å•é¡Œã¸</button>
    </div>

    <script>
        // HTMLã®è¦ç´ ã‚’å–å¾—
        const cardImage = document.getElementById('card-image');
        const optionsArea = document.getElementById('options-area');
        const feedback = document.getElementById('feedback');
        const nextButton = document.getElementById('next-button');

        const NUM_OPTIONS = 6; // é¸æŠè‚¢ã®æ•°
        
        let allCardData = {}; 
        let cardIds = [];     
        let currentCorrectName = ""; // æ­£è§£åï¼ˆå¸¸ã« name_jpï¼‰

        /**
         * ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°: é…åˆ—ã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã™ã‚‹ (Fisher-Yatesã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ )
         */
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        /**
         * 1. ã‚²ãƒ¼ãƒ ã®åˆæœŸåŒ–
         */
        async function initializeGame() {
            try {
                const response = await fetch('data/CardMetadata.json');
                if (!response.ok) throw new Error('CardMetadata.jsonã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
                
                allCardData = await response.json();
                cardIds = Object.keys(allCardData); 
                
                if (cardIds.length < NUM_OPTIONS) {
                    feedback.textContent = `ã‚¯ã‚¤ã‚ºã«ã¯æœ€ä½${NUM_OPTIONS}æšã®ã‚«ãƒ¼ãƒ‰ãŒå¿…è¦ã§ã™ã€‚`;
                    feedback.className = 'incorrect';
                    return;
                }

                loadNewQuestion();

            } catch (error) {
                console.error(error);
                feedback.textContent = 'ã‚¯ã‚¤ã‚ºã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚';
                feedback.className = 'incorrect';
            }
        }

        /**
         * 2. æ–°ã—ã„å•é¡Œã‚’èª­ã¿è¾¼ã‚€
         */
        async function loadNewQuestion() {
            // UIã‚’ãƒªã‚»ãƒƒãƒˆ
            feedback.textContent = '';
            feedback.className = '';
            optionsArea.innerHTML = ''; // é¸æŠè‚¢ã‚’ã‚¯ãƒªã‚¢
            nextButton.style.display = 'none';

            // 1. æ­£è§£ã‚«ãƒ¼ãƒ‰ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«é¸ã¶
            const correctCardIdKey = cardIds[Math.floor(Math.random() * cardIds.length)];
            const correctCardData = allCardData[correctCardIdKey];

            // â˜…å¤‰æ›´ç‚¹2: name_jp ã®ã¿ã‚’ä½¿ç”¨ã™ã‚‹ã‚ˆã†ã«å›ºå®šâ˜…
            currentCorrectName = correctCardData.name_jp; 
            
            // 2. ä¸æ­£è§£ã‚«ãƒ¼ãƒ‰IDã®å€™è£œã‚’é¸ã¶ (æ­£è§£IDã‚’é™¤å¤–)
            let wrongIdKeys = cardIds.filter(id => id !== correctCardIdKey);

            // 3. ä¸æ­£è§£ã‚«ãƒ¼ãƒ‰5æšã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«é¸ã³ã€ãã®åå‰ã‚’å–å¾—
            shuffleArray(wrongIdKeys);
            const wrongOptions = [];
            
            for (let i = 0; wrongOptions.length < NUM_OPTIONS - 1 && i < wrongIdKeys.length; i++) {
                const wrongData = allCardData[wrongIdKeys[i]];
                
                // â˜…å¤‰æ›´ç‚¹3: ä¸æ­£è§£ã®é¸æŠè‚¢ã‚‚ name_jp ã‹ã‚‰å–å¾—â˜…
                const wrongName = wrongData.name_jp; 
                
                // é‡è¤‡ãƒã‚§ãƒƒã‚¯
                if (wrongName !== currentCorrectName && !wrongOptions.includes(wrongName)) {
                    wrongOptions.push(wrongName);
                }
            }
            
            // é¸æŠè‚¢ãƒªã‚¹ãƒˆã‚’ä½œæˆ
            let allOptions = [currentCorrectName, ...wrongOptions];
            // é¸æŠè‚¢ã®æ•°ãŒä¸è¶³ã™ã‚‹å ´åˆã«å‚™ãˆã¦ã‚¹ãƒ©ã‚¤ã‚¹ï¼ˆåŸºæœ¬çš„ã«ä¸è¶³ã—ãªã„ã¯ãšï¼‰
            allOptions = allOptions.slice(0, NUM_OPTIONS); 

            shuffleArray(allOptions); // é¸æŠè‚¢ã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«

            // 4. ç”»åƒã¨é¸æŠè‚¢ãƒœã‚¿ãƒ³ã‚’è¨­å®š
            
            // ç”»åƒã®è¨­å®š
            const cardId = correctCardData.card_id; 
            const currentFileName = `${cardId}.webp`;
            cardImage.src = `images/${currentFileName}`;
            cardImage.alt = 'ã‚«ãƒ¼ãƒ‰ã®ã‚¤ãƒ©ã‚¹ãƒˆ';

            // é¸æŠè‚¢ãƒœã‚¿ãƒ³ã®ç”Ÿæˆ
            allOptions.forEach(option => {
                const button = document.createElement('button');
                button.className = 'option-button';
                button.textContent = option;
                button.setAttribute('data-name', option);
                button.addEventListener('click', handleOptionClick);
                optionsArea.appendChild(button);
            });
        }

        /**
         * 3. é¸æŠè‚¢ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸæ™‚ã®å‡¦ç†
         */
        function handleOptionClick(event) {
            // æ—¢ã«å›ç­”æ¸ˆã¿ã§ã‚ã‚Œã°ä½•ã‚‚ã—ãªã„
            if (nextButton.style.display === 'block') return; 

            const clickedButton = event.target;
            const userGuess = clickedButton.getAttribute('data-name');

            // å…¨ã¦ã®ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
            Array.from(optionsArea.children).forEach(button => {
                button.disabled = true;
                // æ­£è§£ã®ãƒœã‚¿ãƒ³ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
                if (button.getAttribute('data-name') === currentCorrectName) {
                    button.classList.add('correct');
                }
            });

            if (userGuess === currentCorrectName) {
                feedback.textContent = 'æ­£è§£ï¼ ğŸ‰';
                feedback.className = 'correct';
                clickedButton.classList.add('correct');
            } else {
                // ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚‚ name_jp ã«å›ºå®š
                feedback.textContent = `ä¸æ­£è§£... æ­£è§£ã¯ã€Œ${currentCorrectName}ã€ã§ã—ãŸã€‚`;
                feedback.className = 'incorrect';
                clickedButton.classList.add('incorrect');
            }

            // ã€Œæ¬¡ã®å•é¡Œã¸ã€ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
            nextButton.style.display = 'block';
        }

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
        nextButton.addEventListener('click', loadNewQuestion);

        // ãƒšãƒ¼ã‚¸ãŒèª­ã¿è¾¼ã¾ã‚ŒãŸã‚‰ã‚²ãƒ¼ãƒ ã‚’åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', initializeGame);
    </script>
</body>
</html>